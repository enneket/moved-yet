name: Dependency Update

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 10
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'
    
    - name: Check for updates
      id: updates
      run: |
        # æ£€æŸ¥è¿‡æ—¶çš„åŒ…
        pnpm outdated --format json > outdated.json || true
        
        if [ -s outdated.json ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "Found outdated packages:"
          cat outdated.json
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "All packages are up to date"
        fi
    
    - name: Update dependencies
      if: steps.updates.outputs.has_updates == 'true'
      run: |
        # æ›´æ–°éä¸»è¦ç‰ˆæœ¬
        pnpm update
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
        if git diff --quiet pnpm-lock.yaml; then
          echo "No actual changes after update"
          echo "skip_pr=true" >> $GITHUB_ENV
        else
          echo "Dependencies updated"
          echo "skip_pr=false" >> $GITHUB_ENV
        fi
    
    - name: Run tests
      if: steps.updates.outputs.has_updates == 'true' && env.skip_pr == 'false'
      run: |
        pnpm install --frozen-lockfile
        pnpm run compile
        pnpm run lint
        pnpm test || echo "Tests failed, but continuing..."
    
    - name: Create Pull Request
      if: steps.updates.outputs.has_updates == 'true' && env.skip_pr == 'false'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'ğŸ”„ è‡ªåŠ¨æ›´æ–°ä¾èµ–åŒ…'
        body: |
          ## ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–°
          
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ PRï¼Œç”¨äºæ›´æ–°é¡¹ç›®ä¾èµ–åŒ…ã€‚
          
          ### ğŸ“¦ æ›´æ–°å†…å®¹
          - æ›´æ–°äº†éä¸»è¦ç‰ˆæœ¬çš„ä¾èµ–åŒ…
          - ä¿æŒå‘åå…¼å®¹æ€§
          
          ### âœ… è‡ªåŠ¨æ£€æŸ¥
          - [x] ç¼–è¯‘æ£€æŸ¥é€šè¿‡
          - [x] ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡
          - [x] åŸºç¡€æµ‹è¯•è¿è¡Œ
          
          ### ğŸ” éœ€è¦äººå·¥å®¡æŸ¥
          - [ ] æ£€æŸ¥æ›´æ–°æ—¥å¿—ä¸­çš„é‡è¦å˜æ›´
          - [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
          - [ ] éªŒè¯åŠŸèƒ½æ­£å¸¸å·¥ä½œ
          
          ### ğŸ“‹ æ›´æ–°çš„åŒ…
          è¯·æŸ¥çœ‹ `pnpm-lock.yaml` çš„å˜æ›´äº†è§£å…·ä½“æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
        branch: dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated
        reviewers: |
          yaolifeng0629
    
    - name: Clean up
      if: always()
      run: |
        rm -f outdated.json